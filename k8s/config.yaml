apiVersion: v1
kind: ConfigMap
metadata:
  name: demo-config
data:
  redis.conf: |
    bind 0.0.0.0
    protected-mode no
    port 6379
    tcp-backlog 511
    timeout 0
    tcp-keepalive 300
    daemonize no
    supervised no
    pidfile /var/run/redis_6379.pid

  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
      - job_name: 'demo-server'
        static_configs:
          - targets: ['demo-server-clusterip:4000']
        metrics_path: /metrics

  loki-config.yaml: |
    auth_enabled: false
    server:
      http_listen_port: 3100
      grpc_listen_port: 9096
    common:
      path_prefix: /tmp/loki
      storage:
        filesystem:
          chunks_directory: /tmp/loki/chunks
          rules_directory: /tmp/loki/rules
      replication_factor: 1
      ring:
        kvstore:
          store: inmemory
    query_range:
      results_cache:
        cache:
          embedded_cache:
            enabled: true
            max_size_mb: 100
    schema_config:
      configs:
        - from: 2020-10-24
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h
    ruler:
      alertmanager_url: http://localhost:9093

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: demo-server-config
data:
  NODE_ENV: "production"
  CLIENT_URL: "http://frontend-clusterip:2000"
  REDIS_HOST: "redis"
  REDIS_PORT: "6379"
  DISABLE_REDIS_QUEUES: "false"
  PENDING_ORDER_WORKER_CONCURRENCY: "5"
  EMAIL_WORKER_CONCURRENCY: "10"
  RATE_LIMIT_REQUESTS: "100"
  LOKI_URL: "http://grafana-loki-clusterip:3100"

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus-clusterip:9090
      isDefault: true
    - name: Loki
      type: loki
      access: proxy
      url: http://grafana-loki-clusterip:3100